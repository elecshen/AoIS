# AoIS Lab 7
Проект консольного приложения на .NET Core 6.

За основу взят [проект парсера на Selenium](https://github.com/elecshen/AoIS/tree/Lb6_Selenium).

Миграции представляют план перехода базы данных от старой схемы к новой. По способу работы похожи на систему контроля версий.

Для создания миграции используется команда **консоли диспетчера пакетов**:

    Add-Migration название_миграции

> Название может быть любым, главное чтобы миграции имели разные названия.

После создания первой миграции появится папка Migration и два файла в ней:

 - **XXXXXXXXXXXXXX_название_миграции.cs**: основной файл миграции, который содержит все применяемые действия.
 - **[Имя_контекста_данных]ModelSnapshot.cs**: содержит текущее состояние модели, используется при создании следующей миграции

В файле миграции будет класс с двумя методами `Up()` и `Down()` для применения и отката миграции соответственно.
При создании первой миграции в этих методах будет описано полное создание и удаление всех сущностей, которые описаны в коде проекта.

Для применения миграции используется команда

    Update-Database
Данная команда применяет все новые миграции. 

Так как миграции рассчитаны на работу с нуля, а база данных уже существует, то вызов этой команды приведёт к ошибке и база данных останется в исходном состоянии. Однако для дальнейшей работы нам потребуется применить начальную миграцию. Для этого нужно закомментировать содержимое метода `Up()`. После этого миграция применится без всяких ошибок.

> В общем счете, добавление миграции генерирует код для изменения бд до текущего состояния модели относительно последней миграции. Однако, генерируемый код может быть изменён вручную, главное чтобы код миграции создавал правильную структуру, ибо результат миграции не проверяется. О правильности изменённой структуры можно будет узнать только по ошибкам работы с бд.

После применения миграции в базе данных появится таблица **__EFMigrationsHistory**, которая хранит историю миграций. По этой таблице Entity Framework узнаёт какие миграции применены, а какие нет.

Теперь, когда начальная миграция создана и применена, мы можем менять сущности и их структуру в коде. Дальнейшие миграции будут фиксировать изменения в сущностях, которые и нужны в лабораторной работе.

Ещё пару полезных команд для управления миграциями.

Команда для удаления созданной миграции. **Удалить миграцию можно только если она не применена.**

    Remove-Migration
Никакие дополнительные аргументы не требуются. Команда просто удаляет последнюю миграцию. Удалить промежуточную миграцию нельзя. Единственный способ - удалить все миграции, созданные позднее нужной.

Один из аргументов команды обновления бд позволяет выбирать необходимую миграцию.

    Update-Database -Migration:"название_миграции"
С помощью этой команды можно так же откатить состояние бд, чтобы, например, удалить ненужную миграцию.
